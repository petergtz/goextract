package main

import (
	"fmt"
	"go/ast"
	"go/token"
	"reflect"

	"github.com/petergtz/goextract/util"
)

func extractMultipleStatements(
	astFile *ast.File,
	fileSet *token.FileSet,
	stmtsToExtract []ast.Node,
	parentNode ast.Node,
	extractedFuncName string) {
	params := make(map[string]*ast.Ident) //varIdentsUsedIn([]ast.Node{expr})
	//	varsDeclaredWithinStmtsToExtract :=
	//		varIdentsDeclaredWithin(stmtsToExtract)

	var varsUsedAfterwards map[string]*ast.Ident

	var stmts []ast.Stmt

	switch typedParentNode := parentNode.(type) {
	case *ast.BlockStmt:
		indexOfExtractedStmt := MyExtractedFunc(stmtsToExtract, typedParentNode)

		for _, node := range stmtsToExtract {
			stmts = append(stmts, node.(ast.Stmt))
		}
		if len(varsUsedAfterwards) == 0 {
			typedParentNode.List[indexOfExtractedStmt] = &ast.ExprStmt{X: callExprWith(extractedFuncName, params)}

		} else {
			typedParentNode.List[indexOfExtractedStmt] = &ast.AssignStmt{
				Lhs: []ast.Expr{ast.NewIdent(namesOf(varsUsedAfterwards)[0])},
				Tok: token.DEFINE,
				Rhs: []ast.Expr{callExprWith(extractedFuncName, params)},
			}

		}
		typedParentNode.List = append(typedParentNode.List[:indexOfExtractedStmt+1], typedParentNode.List[indexOfExtractedStmt+len(stmtsToExtract):]...)

	default:
		panic(fmt.Sprintf("Type %v not supported yet", reflect.TypeOf(parentNode)))
	}

	astFile.Decls = append(astFile.Decls, multipleStmtFuncDeclWith(
		extractedFuncName,
		fieldsFrom(params),
		stmts,
		exprsFrom(varsUsedAfterwards),
	))
}

func callExprWith(funcName string, params map[string]*ast.Ident) *ast.CallExpr {
	return nil
}

func singleExprStmtFuncDeclWith(funcName string, fields []*ast.Field, returnExpr ast.Expr) *ast.FuncDecl {
	return nil
}

func fieldsFrom(params map[string]*ast.Ident) []*ast.Field {
	return nil
}

func MyExtractedFunc(stmtsToExtract []ast.Node, typedParentNode *ast.BlockStmt) int {
	var indexOfExtractedStmt int
	for i, stmt := range typedParentNode.List {
		if stmt == stmtsToExtract[0] {
			indexOfExtractedStmt = i
			break
		}
	}
	return indexOfExtractedStmt
}
